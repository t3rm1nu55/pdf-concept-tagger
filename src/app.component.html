<main class="h-screen w-full bg-gray-950 text-gray-200 font-sans p-4 flex flex-col overflow-hidden">
  
  <!-- Header -->
  <header class="flex-none mb-4 pb-4 border-b border-gray-800 flex flex-col gap-4">
    <div class="flex justify-between items-center">
        <div>
           <h1 class="text-2xl font-bold text-white tracking-tight flex items-center">
               Ontology Engine
               <span class="ml-3 px-2 py-0.5 rounded bg-indigo-500/10 text-indigo-400 text-xs font-mono border border-indigo-500/30">v6.2 ARCHITECT</span>
           </h1>
        </div>
        
        @if (processingState() === 'success' || processingState() === 'processing') {
          <div class="flex items-center gap-4">
             @if (processingState() === 'processing') {
                 <div class="flex items-center gap-2 px-3 py-1.5 text-indigo-400 animate-pulse">
                     <span class="text-lg">ðŸ“¡</span>
                     <span class="text-xs font-bold uppercase tracking-widest">Neural Uplink Active</span>
                 </div>
             }

            @if (currentRound().number > 0) {
                 <div class="flex items-center gap-2 bg-gray-900 border border-gray-700 rounded px-3 py-1.5 animate-fade-in">
                    <span class="text-xs text-gray-400 uppercase tracking-widest">Round</span>
                    <span class="text-sm font-bold text-white font-mono bg-indigo-600 px-2 rounded">{{ currentRound().number }}</span>
                    <span class="text-sm text-indigo-200 font-bold uppercase">{{ currentRound().name }}</span>
                 </div>
             }

            @if (totalPages() > 0 && currentPageData()?.pageNumber! < totalPages() && processingState() === 'success') {
                <button (click)="loadNextPage()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium py-1.5 px-4 rounded border border-indigo-400 transition-colors flex items-center shadow-lg shadow-indigo-500/20">
                    <span class="mr-2">ðŸ“„</span> Analyze Page {{ currentPageData()?.pageNumber! + 1 }}
                </button>
            }

            <button (click)="reset()" class="bg-gray-800 hover:bg-gray-700 text-gray-200 text-sm font-medium py-1.5 px-4 rounded border border-gray-700 transition-colors flex items-center">
                <span class="mr-2">â†º</span> Reset
            </button>
          </div>
        }
    </div>

    <!-- Agent Council -->
    @if (processingState() !== 'idle' && processingState() !== 'uninitialized') {
        <div class="grid grid-cols-5 gap-4">
            @for (agent of activeAgents(); track agent.name) {
                <div class="bg-gray-900 border border-gray-800 rounded p-2 flex flex-col relative overflow-hidden transition-all duration-300" 
                     [class.border-indigo-500]="agent.status === 'active'"
                     [class.bg-indigo-900/10]="agent.status === 'active'">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold font-mono tracking-wider" [class]="agent.color">{{ agent.name }}</span>
                        @if (agent.status === 'active') { <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> }
                    </div>
                    <div class="text-[10px] text-gray-400 truncate">{{ agent.goal }}</div>
                </div>
            }
        </div>
    }
  </header>

  <!-- Main Workspace -->
  <div class="flex-grow flex flex-col min-h-0">
    @switch (processingState()) {
      @case ('idle') {
        <div class="flex-grow flex items-center justify-center p-8">
            <div class="bg-gray-900 border-2 border-dashed border-gray-800 rounded-2xl p-16 text-center max-w-2xl w-full hover:border-indigo-500/50 transition-colors group">
                <h2 class="text-3xl font-bold text-white mb-3">Initialize System</h2>
                <p class="text-gray-400 mb-8 max-w-md mx-auto">Deploy Curator and Observer Agents for structured analysis.</p>
                <label class="inline-flex relative cursor-pointer group-hover:shadow-indigo-500/20 shadow-lg transition-shadow">
                    <span class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-8 rounded-lg transition-colors">Analyze Document</span>
                    <input type="file" class="sr-only" (change)="onFileSelected($event)" accept="application/pdf">
                </label>
            </div>
        </div>
      }
      @case ('error') {
          <div class="flex items-center justify-center h-full text-red-400">{{ errorMessage() }}</div>
      }
      @default {
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
                
                <!-- LEFT PANEL (Locker / Source) -->
                <div class="lg:col-span-3 flex flex-col h-full min-h-0 bg-gray-900 rounded-lg border border-gray-800 overflow-hidden">
                    <div class="flex-none flex border-b border-gray-800">
                        <button (click)="toggleView('source')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors" [class.bg-gray-800]="viewMode() === 'source'" [class.text-white]="viewMode() === 'source'" [class.border-b-2]="viewMode() === 'source'" [class.border-indigo-500]="viewMode() === 'source'">Source</button>
                        <button (click)="toggleView('locker')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors" [class.bg-gray-800]="viewMode() === 'locker'" [class.text-white]="viewMode() === 'locker'" [class.border-b-2]="viewMode() === 'locker'" [class.border-indigo-500]="viewMode() === 'locker'">Locker</button>
                    </div>

                    <div class="flex-grow overflow-hidden relative">
                        @if (viewMode() === 'source') {
                             <div class="h-full overflow-y-auto custom-scrollbar bg-black/40 relative">
                                @if (currentPageData(); as page) {
                                    <div class="relative">
                                        <img [src]="page.imageDataUrl" class="w-full h-auto block opacity-80">
                                        @for (concept of page.concepts; track $index) {
                                            @if (concept.boundingBox) {
                                                <div class="absolute border-2 cursor-pointer mix-blend-screen hover:bg-white/10"
                                                [class]="selectedConcept()?.id === concept.id ? 'border-yellow-400 bg-yellow-400/20' : 'border-indigo-500/30'"
                                                [style]="getBoundingBoxStyle(concept.boundingBox)"
                                                (click)="selectConcept(concept)"></div>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        } @else {
                             <!-- LOCKER COMPONENT (The Organizer) -->
                             <app-locker [nodes]="storedNodes()" [selectedId]="selectedConcept()?.id" (select)="selectConcept($event)"></app-locker>
                        }
                    </div>

                    <!-- INSPECTOR COMPONENT -->
                    <app-inspector [concept]="selectedConcept()"></app-inspector>
                </div>

                <!-- CENTER PANEL (Graph) -->
                <div class="lg:col-span-6 bg-gray-900 rounded-lg border border-gray-800 flex flex-col relative overflow-hidden h-full shadow-inner">
                    <div #graphContainer class="flex-grow bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-800/40 via-gray-900 to-gray-950"></div>
                    
                    <!-- Graph Legend Overlay -->
                    <div class="absolute top-2 left-2 bg-gray-900/80 backdrop-blur border border-gray-800 rounded p-2 text-[10px] space-y-1 pointer-events-none select-none">
                        <div class="flex items-center gap-2">
                           <span class="w-2 h-2 rounded-full bg-indigo-600 border border-indigo-400"></span>
                           <span class="text-gray-300">Concepts</span>
                        </div>
                        <div class="flex items-center gap-2">
                           <span class="w-2 h-2 rounded bg-orange-500 border border-orange-300"></span>
                           <span class="text-gray-300">Hypernodes (Contexts)</span>
                        </div>
                        <div class="flex items-center gap-2">
                           <!-- Diamond shape using CSS clip-path or transform -->
                           <span class="w-2 h-2 bg-pink-500 border border-pink-300 rotate-45 transform origin-center"></span>
                           <span class="text-gray-300">Reality Priors</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL (Log / Debate / Context) -->
                <div class="lg:col-span-3 flex flex-col h-full min-h-0 bg-gray-900 rounded-lg border border-gray-800 overflow-hidden">
                    <div class="flex border-b border-gray-800">
                        <button (click)="toggleRightPanel('log')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors" [class.border-b-2]="rightPanelMode() === 'log'" [class.border-indigo-500]="rightPanelMode() === 'log'">Log</button>
                        <button (click)="toggleRightPanel('hypotheses')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors" [class.border-b-2]="rightPanelMode() === 'hypotheses'" [class.border-indigo-500]="rightPanelMode() === 'hypotheses'">Debate</button>
                        <button (click)="toggleRightPanel('context')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors" [class.border-b-2]="rightPanelMode() === 'context'" [class.border-indigo-500]="rightPanelMode() === 'context'">Context</button>
                    </div>

                    <div class="flex-grow overflow-auto p-4 custom-scrollbar bg-black/50">
                        @switch (rightPanelMode()) {
                            @case ('log') {
                                <div class="flex justify-end mb-2 gap-2 items-center">
                                    @if (latestOptimization()) {
                                        <span class="text-[10px] text-green-400 font-mono border border-green-900 bg-green-900/20 px-1 rounded">Score: {{ optimizationScore() }}</span>
                                    }
                                    <button (click)="downloadLog()" class="text-[10px] text-indigo-400 hover:text-indigo-300 underline">Download JSON</button>
                                </div>
                                
                                @if (latestOptimization()) {
                                    <div class="mb-3 p-2 bg-pink-900/20 border border-pink-800 rounded text-xs text-pink-300">
                                        <strong class="block uppercase text-[10px] text-pink-500 mb-1">Critic Suggestion</strong>
                                        {{ latestOptimization() }}
                                    </div>
                                }

                                <div #logsContainer class="space-y-3 font-mono text-xs text-gray-300">
                                    @for (log of logService.uiLogs(); track $index) {
                                        <div class="animate-fade-in pl-2 border-l-2"
                                             [class.border-gray-700]="log.type === 'SYSTEM'"
                                             [class.border-indigo-500]="log.type === 'AGENT_MSG'"
                                             [class.border-yellow-500]="log.type === 'EXPLANATION'"
                                             [class.italic]="log.type === 'EXPLANATION'"
                                             [class.text-yellow-100]="log.type === 'EXPLANATION'">
                                            @if (log.agent) { <span class="font-bold opacity-50 block text-[9px]">{{ log.agent }}</span> }
                                            {{ log.message }}
                                        </div>
                                    }
                                </div>
                            }
                            @case ('hypotheses') {
                                <div class="space-y-4">
                                    @for (h of hypotheses(); track h.id) {
                                        <div class="bg-gray-800 border-l-4 border-pink-500 rounded p-3 animate-fade-in">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="text-[10px] font-bold text-pink-400 uppercase">Hypothesis</span>
                                                <span class="text-[10px] px-1.5 rounded bg-gray-700 text-gray-300">{{ h.status }}</span>
                                            </div>
                                            <div class="text-sm font-medium text-white mb-2">{{ h.claim }}</div>
                                            <div class="text-xs text-gray-400 italic border-t border-gray-700 pt-2 mt-2">"{{ h.evidence }}"</div>
                                        </div>
                                    } @empty {
                                        <div class="text-center text-gray-500 italic mt-8">
                                            No disputes raised by the Critic Agent yet.
                                        </div>
                                    }
                                </div>
                            }
                            @case ('context') {
                                <div class="space-y-3">
                                    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-2">Operational Axioms</div>
                                    @for (p of priors(); track p.id) {
                                        <div class="bg-gray-900 border border-gray-700 rounded p-3 animate-fade-in flex gap-2">
                                           <div class="text-xl">ðŸ“œ</div>
                                           <div>
                                               <div class="text-sm text-gray-200">{{ p.axiom }}</div>
                                               <div class="text-[10px] text-gray-500 mt-1">Weight: {{ p.weight }}</div>
                                           </div>
                                        </div>
                                    } @empty {
                                         <div class="text-center text-gray-500 italic mt-8">
                                            Analyzing document structure for axioms...
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
             </div>
      }
    }
  </div>
</main>